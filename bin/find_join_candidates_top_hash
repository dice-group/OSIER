#!/usr/bin/env python

import pickle
import os
import argparse

from osier.tablefactory import load_atomic_tables_lazy
from osier.join import get_top_hash
from osier.pathes import ATOMIC_TABLES_TOP_HASHES_SIMPLE,\
    ATOMIC_TABLES_TOP_HASHES_LEMMATIZE

parser = argparse.ArgumentParser(description="""Find join candidates for table corpus.""")
parser.add_argument('mode', help="Mode 'simple' or 'lemmatize'")
args = parser.parse_args()
vectorization_type = args.mode

if vectorization_type == "simple":
    _cache = ATOMIC_TABLES_TOP_HASHES_SIMPLE
elif vectorization_type == "lemmatize":
    _cache = ATOMIC_TABLES_TOP_HASHES_LEMMATIZE

join_candidates = {}

if os.path.exists(_cache):
    _f = open(_cache, "rb")
    join_candidates = pickle.load(_f)
    _f.close()
else:
    for _id, atomic_table in load_atomic_tables_lazy():
        if not isinstance(atomic_table[0], list):
            continue
        _hash = get_top_hash(atomic_table, vectorization_type=vectorization_type)
        if not _hash in join_candidates:
            join_candidates[_hash] = []
        join_candidates[_hash].append(_id)
    _f = open(_cache, 'wb')
    pickle.dump(join_candidates, _f)
    _f.close()

print("Done!")
